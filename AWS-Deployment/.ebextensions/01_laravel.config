files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_optimize_laravel.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      cd /var/www/html
      
      # Set proper permissions
      sudo chown -R webapp:webapp storage bootstrap/cache
      sudo chmod -R 775 storage bootstrap/cache
      
      # Clear and cache Laravel
      sudo -u webapp php artisan config:clear
      sudo -u webapp php artisan cache:clear
      sudo -u webapp php artisan route:clear
      sudo -u webapp php artisan view:clear
      
      # Optimize for production
      sudo -u webapp php artisan config:cache
      sudo -u webapp php artisan route:cache
      sudo -u webapp php artisan view:cache
      
      # Run migrations
      sudo -u webapp php artisan migrate --force

container_commands:
  01_install_node:
    command: |
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
      . ~/.nvm/nvm.sh
      nvm install node
      nvm use node
    leader_only: true

  02_install_composer_dependencies:
    command: composer install --no-dev --optimize-autoloader
    leader_only: true

  03_build_assets:
    command: |
      . ~/.nvm/nvm.sh
      npm install
      npm run build
    leader_only: true
